# Платформенная архитектура sing_box

## Обзор

Пакет `sing_box` использует Flutter Platform Channels для взаимодействия с нативными платформами Android и iOS. Все методы обрабатываются через Method Channels, а события статуса и статистики передаются через Event Channels.

## Каналы связи

### Method Channel
- **Имя:** `sing_box`
- **Назначение:** Синхронные вызовы методов между Flutter и нативным кодом
- **Тип:** `MethodChannel`

### Event Channels
- **Имя статуса:** `sing_box/status`
- **Имя статистики:** `sing_box/stats`
- **Назначение:** Асинхронная передача событий от нативного кода к Flutter
- **Тип:** `EventChannel`

## Методы Method Channel

### Инициализация

#### `initialize`
Инициализирует плагин на нативной платформе.

**Параметры:** Нет

**Возвращает:** `bool` - успешность инициализации

**TODO:** Реализовать инициализацию sing-box на платформе

---

#### `getPlatformVersion`
Получает версию платформы.

**Параметры:** Нет

**Возвращает:** `String?` - версия платформы

**TODO:** Реализовать получение версии платформы

---

### Подключение VPN

#### `connect`
Подключается к VPN с указанной конфигурацией.

**Параметры:**
- `config` (String) - JSON строка с конфигурацией сервера

**Возвращает:** `bool` - успешность подключения

**TODO:** Реализовать подключение к VPN через sing-box

---

#### `disconnect`
Отключается от VPN.

**Параметры:** Нет

**Возвращает:** `bool` - успешность отключения

**TODO:** Реализовать отключение от VPN

---

### Статус и статистика

#### `getConnectionStatus`
Получает текущий статус подключения.

**Параметры:** Нет

**Возвращает:** `String` - статус подключения:
- `"disconnected"` - не подключено
- `"connecting"` - подключение в процессе
- `"connected"` - подключено
- `"disconnecting"` - отключение в процессе
- `"disconnectedByUser"` - отключено пользователем
- `"connectionLost"` - потеря связи с сервером
- `"error"` - ошибка подключения

**TODO:** Реализовать получение статуса подключения из sing-box

---

#### `getConnectionStats`
Получает текущую статистику подключения.

**Параметры:** Нет

**Возвращает:** `Map<String, dynamic>` с полями:
- `downloadSpeed` (int) - скорость загрузки в байтах в секунду
- `uploadSpeed` (int) - скорость отдачи в байтах в секунду
- `bytesSent` (int) - всего отправлено байт
- `bytesReceived` (int) - всего получено байт
- `ping` (int?) - текущий пинг в миллисекундах (может быть null)
- `connectionDuration` (int) - время подключения в миллисекундах

**TODO:** Реализовать получение статистики из sing-box

---

### Измерения

#### `testSpeed`
Измеряет скорость подключения.

**Параметры:** Нет

**Возвращает:** `Map<String, dynamic>` с полями:
- `downloadSpeed` (int) - скорость загрузки в байтах в секунду
- `uploadSpeed` (int) - скорость отдачи в байтах в секунду
- `success` (bool) - успешность теста
- `errorMessage` (String?) - сообщение об ошибке, если тест не удался

**TODO:** Реализовать тест скорости через sing-box

---

#### `pingCurrentServer`
Измеряет пинг до текущего сервера.

**Параметры:** Нет

**Возвращает:** `Map<String, dynamic>` с полями:
- `ping` (int) - пинг в миллисекундах
- `success` (bool) - успешность пинга
- `errorMessage` (String?) - сообщение об ошибке
- `address` (String?) - адрес, до которого измерялся пинг

**TODO:** Реализовать пинг до текущего сервера

---

#### `pingConfig`
Измеряет пинг до указанного конфига.

**Параметры:**
- `config` (String) - JSON строка с конфигурацией сервера

**Возвращает:** `Map<String, dynamic>` с полями:
- `ping` (int) - пинг в миллисекундах
- `success` (bool) - успешность пинга
- `errorMessage` (String?) - сообщение об ошибке
- `address` (String?) - адрес, до которого измерялся пинг

**TODO:** Реализовать пинг до указанного конфига

---

### Исключения (Bypass)

#### `addAppToBypass`
Добавляет приложение в список исключений.

**Параметры:**
- `packageName` (String) - имя пакета приложения (Android) или bundle ID (iOS)

**Возвращает:** `bool` - успешность добавления

**TODO:** Реализовать добавление приложения в bypass список

---

#### `removeAppFromBypass`
Удаляет приложение из списка исключений.

**Параметры:**
- `packageName` (String) - имя пакета приложения (Android) или bundle ID (iOS)

**Возвращает:** `bool` - успешность удаления

**TODO:** Реализовать удаление приложения из bypass списка

---

#### `getBypassApps`
Получает список приложений в исключениях.

**Параметры:** Нет

**Возвращает:** `List<String>` - список имен пакетов приложений

**TODO:** Реализовать получение списка приложений в bypass

---

#### `addDomainToBypass`
Добавляет домен/сайт в список исключений.

**Параметры:**
- `domain` (String) - доменное имя или IP адрес

**Возвращает:** `bool` - успешность добавления

**TODO:** Реализовать добавление домена в bypass список

---

#### `removeDomainFromBypass`
Удаляет домен/сайт из списка исключений.

**Параметры:**
- `domain` (String) - доменное имя или IP адрес

**Возвращает:** `bool` - успешность удаления

**TODO:** Реализовать удаление домена из bypass списка

---

#### `getBypassDomains`
Получает список доменов/сайтов в исключениях.

**Параметры:** Нет

**Возвращает:** `List<String>` - список доменов/сайтов

**TODO:** Реализовать получение списка доменов в bypass

---

#### `switchServer`
Сменяет текущий сервер.

**Параметры:**
- `config` (String) - JSON строка с новой конфигурацией сервера

**Возвращает:** `bool` - успешность смены сервера

**TODO:** Реализовать смену сервера (остановка текущего, смена конфигурации, подключение к новому)

---

### Настройки

#### `saveSettings`
Сохраняет настройки плагина.

**Параметры:**
- `settings` (Map<String, dynamic>) - объект настроек со следующими полями:
  - `autoConnectOnStart` (bool)
  - `autoReconnectOnDisconnect` (bool)
  - `killSwitch` (bool)
  - `blockedApps` (List<String>)
  - `blockedDomains` (List<String>)
  - `bypassSubnets` (List<String>)
  - `dnsServers` (List<String>)
  - `activeServerConfigId` (String?)
  - `serverConfigs` (List<Map<String, dynamic>>)

**Возвращает:** `bool` - успешность сохранения

**TODO:** Реализовать сохранение настроек (SharedPreferences на Android, UserDefaults на iOS)

---

#### `loadSettings`
Загружает сохраненные настройки.

**Параметры:** Нет

**Возвращает:** `Map<String, dynamic>` - объект настроек (см. `saveSettings`)

**TODO:** Реализовать загрузку настроек из хранилища

---

#### `getSettings`
Получает текущие настройки.

**Параметры:** Нет

**Возвращает:** `Map<String, dynamic>` - объект настроек (см. `saveSettings`)

**TODO:** Реализовать получение текущих настроек

---

#### `updateSetting`
Обновляет отдельный параметр настроек.

**Параметры:**
- `key` (String) - ключ параметра (autoConnectOnStart, autoReconnectOnDisconnect, killSwitch)
- `value` (dynamic) - значение параметра

**Возвращает:** `bool` - успешность обновления

**TODO:** Реализовать обновление отдельного параметра настроек

---

### Конфигурации серверов

#### `addServerConfig`
Добавляет конфигурацию сервера.

**Параметры:**
- `config` (Map<String, dynamic>) - конфигурация сервера со следующими полями:
  - `id` (String) - уникальный идентификатор
  - `name` (String) - название
  - `config` (String) - JSON строка с конфигурацией
  - `protocol` (String) - протокол (vmess, vless, shadowsocks, trojan, etc.)
  - `server` (String) - сервер (hostname или IP)
  - `port` (int) - порт
  - `enabled` (bool) - включена ли конфигурация

**Возвращает:** `bool` - успешность добавления

**TODO:** Реализовать добавление конфигурации сервера

---

#### `removeServerConfig`
Удаляет конфигурацию сервера.

**Параметры:**
- `configId` (String) - идентификатор конфигурации

**Возвращает:** `bool` - успешность удаления

**TODO:** Реализовать удаление конфигурации сервера

---

#### `updateServerConfig`
Обновляет конфигурацию сервера.

**Параметры:**
- `config` (Map<String, dynamic>) - обновленная конфигурация (см. `addServerConfig`)

**Возвращает:** `bool` - успешность обновления

**TODO:** Реализовать обновление конфигурации сервера

---

#### `getServerConfigs`
Получает все конфигурации серверов.

**Параметры:** Нет

**Возвращает:** `List<Map<String, dynamic>>` - список конфигураций (см. `addServerConfig`)

**TODO:** Реализовать получение всех конфигураций серверов

---

#### `getServerConfig`
Получает конфигурацию сервера по ID.

**Параметры:**
- `configId` (String) - идентификатор конфигурации

**Возвращает:** `Map<String, dynamic>?` - конфигурация или null если не найдена

**TODO:** Реализовать получение конфигурации по ID

---

#### `setActiveServerConfig`
Устанавливает активную конфигурацию сервера.

**Параметры:**
- `configId` (String) - идентификатор конфигурации

**Возвращает:** `bool` - успешность установки

**TODO:** Реализовать установку активной конфигурации

---

#### `getActiveServerConfig`
Получает активную конфигурацию сервера.

**Параметры:** Нет

**Возвращает:** `Map<String, dynamic>?` - активная конфигурация или null

**TODO:** Реализовать получение активной конфигурации

---

### Заблокированные приложения и домены

#### `addBlockedApp`
Добавляет приложение в список заблокированных.

**Параметры:**
- `packageName` (String) - имя пакета приложения (Android) или bundle ID (iOS)

**Возвращает:** `bool` - успешность добавления

**TODO:** Реализовать добавление приложения в блокировку

---

#### `removeBlockedApp`
Удаляет приложение из списка заблокированных.

**Параметры:**
- `packageName` (String) - имя пакета приложения (Android) или bundle ID (iOS)

**Возвращает:** `bool` - успешность удаления

**TODO:** Реализовать удаление приложения из блокировки

---

#### `getBlockedApps`
Получает список заблокированных приложений.

**Параметры:** Нет

**Возвращает:** `List<String>` - список имен пакетов заблокированных приложений

**TODO:** Реализовать получение списка заблокированных приложений

---

#### `addBlockedDomain`
Добавляет домен/сайт в список заблокированных.

**Параметры:**
- `domain` (String) - доменное имя или IP адрес

**Возвращает:** `bool` - успешность добавления

**TODO:** Реализовать добавление домена в блокировку

---

#### `removeBlockedDomain`
Удаляет домен/сайт из списка заблокированных.

**Параметры:**
- `domain` (String) - доменное имя или IP адрес

**Возвращает:** `bool` - успешность удаления

**TODO:** Реализовать удаление домена из блокировки

---

#### `getBlockedDomains`
Получает список заблокированных доменов/сайтов.

**Параметры:** Нет

**Возвращает:** `List<String>` - список заблокированных доменов/сайтов

**TODO:** Реализовать получение списка заблокированных доменов

---

### Исключенные подсети (Bypass Subnets)

#### `addSubnetToBypass`
Добавляет подсеть в список исключений.

**Параметры:**
- `subnet` (String) - подсеть в формате CIDR (например: "192.168.1.0/24", "10.0.0.0/8")

**Возвращает:** `bool` - успешность добавления

**TODO:** Реализовать добавление подсети в bypass список

---

#### `removeSubnetFromBypass`
Удаляет подсеть из списка исключений.

**Параметры:**
- `subnet` (String) - подсеть в формате CIDR

**Возвращает:** `bool` - успешность удаления

**TODO:** Реализовать удаление подсети из bypass списка

---

#### `getBypassSubnets`
Получает список подсетей в исключениях.

**Параметры:** Нет

**Возвращает:** `List<String>` - список подсетей в формате CIDR

**TODO:** Реализовать получение списка подсетей в bypass

---

### DNS серверы

#### `addDnsServer`
Добавляет DNS сервер.

**Параметры:**
- `dnsServer` (String) - IP адрес DNS сервера (например: "8.8.8.8", "1.1.1.1")

**Возвращает:** `bool` - успешность добавления

**TODO:** Реализовать добавление DNS сервера

---

#### `removeDnsServer`
Удаляет DNS сервер.

**Параметры:**
- `dnsServer` (String) - IP адрес DNS сервера

**Возвращает:** `bool` - успешность удаления

**TODO:** Реализовать удаление DNS сервера

---

#### `getDnsServers`
Получает список DNS серверов.

**Параметры:** Нет

**Возвращает:** `List<String>` - список IP адресов DNS серверов

**TODO:** Реализовать получение списка DNS серверов

---

#### `setDnsServers`
Устанавливает DNS серверы (заменяет все существующие).

**Параметры:**
- `dnsServers` (List<String>) - список IP адресов DNS серверов

**Возвращает:** `bool` - успешность установки

**TODO:** Реализовать установку DNS серверов

---

## Event Channels

### `sing_box/status` - Статус подключения

Передает обновления статуса подключения в реальном времени.

**Тип события:** `String`

**Возможные значения:**
- `"disconnected"` - не подключено
- `"connecting"` - подключение в процессе
- `"connected"` - подключено
- `"disconnecting"` - отключение в процессе
- `"disconnectedByUser"` - отключено пользователем
- `"connectionLost"` - потеря связи с сервером
- `"error"` - ошибка подключения

**TODO:** Реализовать поток событий статуса подключения
- Отслеживать изменения статуса в sing-box
- Эмитить события при каждом изменении статуса
- Обрабатывать ошибки и закрытие потока

---

### `sing_box/stats` - Статистика подключения

Передает обновления статистики подключения в реальном времени.

**Тип события:** `Map<String, dynamic>`

**Поля события:**
- `downloadSpeed` (int) - скорость загрузки в байтах в секунду
- `uploadSpeed` (int) - скорость отдачи в байтах в секунду
- `bytesSent` (int) - всего отправлено байт
- `bytesReceived` (int) - всего получено байт
- `ping` (int?) - текущий пинг в миллисекундах (может быть null)
- `connectionDuration` (int) - время подключения в миллисекундах

**TODO:** Реализовать поток событий статистики
- Отслеживать статистику подключения в sing-box
- Эмитить события с заданной периодичностью (например, каждую секунду)
- Обрабатывать ошибки и закрытие потока

---

## Android реализация

### Файлы
- `android/src/main/kotlin/com/qusadprod/sing_box/SingBoxPlugin.kt` - основной плагин
- `android/build.gradle` - конфигурация сборки
- `android/src/main/AndroidManifest.xml` - манифест приложения

### Зависимости
- Kotlin
- Android SDK 21+
- Flutter Embedding API

### Особенности реализации
- Использование `MethodChannel` для обработки вызовов методов
- Использование `EventChannel` для потоков событий
- Обработка всех методов через `when` выражение
- Возврат безопасных значений по умолчанию для всех методов

---

## iOS реализация

### Файлы
- `ios/Classes/SingBoxPlugin.swift` - основной плагин
- `ios/sing_box.podspec` - конфигурация CocoaPods

### Зависимости
- Swift 5.0+
- iOS 12.0+
- Flutter Embedding API

### Особенности реализации
- Использование `FlutterMethodChannel` для обработки вызовов методов
- Использование `FlutterEventChannel` для потоков событий
- Обработка всех методов через `switch` выражение
- Использование `NSNull()` для nullable значений
- Возврат безопасных значений по умолчанию для всех методов

---

## Общие рекомендации

1. **Обработка ошибок:** Все методы должны обрабатывать ошибки и возвращать безопасные значения
2. **Асинхронность:** Длительные операции должны выполняться асинхронно
3. **Валидация:** Проверять входные параметры перед использованием
4. **Логирование:** Логировать важные события для отладки
5. **Потоки событий:** Убедиться, что потоки событий правильно закрываются при отключении плагина

---

## Интеграция с sing-box

Для реализации методов необходимо интегрировать нативный код с библиотекой sing-box:

- **Android:** Использовать JNI для вызова функций sing-box или использовать готовые Android библиотеки
- **iOS:** Использовать C/Objective-C интерфейсы sing-box или готовые iOS библиотеки

Все методы помечены `//TODO` и должны быть реализованы с использованием sing-box API.

